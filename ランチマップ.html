<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>„Ç™„Éï„Ç£„ÇπÈ£≤È£üÂ∫ó„É¨„Ç≥„É°„É≥„ÉÄ„Éº</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 1200px;
        width: 100%;
        padding: 40px;
        animation: slideIn 0.5s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      h1 {
        color: #333;
        font-size: 2.5em;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .subtitle {
        color: #666;
        font-size: 1.1em;
      }

      .login-section {
        text-align: center;
        margin: 40px 0;
      }

      .google-login-btn {
        background: #4285f4;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 30px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
      }

      .google-login-btn:hover {
        background: #357ae8;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
      }

      .filters {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .filter-group {
        flex: 1;
        min-width: 200px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 500;
      }

      select {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: white;
      }

      select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .restaurant-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 25px;
        margin-top: 30px;
      }

      .restaurant-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .restaurant-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      }

      .restaurant-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
      }

      .restaurant-info {
        padding: 20px;
      }

      .restaurant-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 10px;
      }

      .restaurant-name {
        font-size: 1.3em;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
      }

      .rating {
        display: flex;
        align-items: center;
        gap: 5px;
        color: #ff9800;
        font-weight: bold;
      }

      .genre-tag {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        margin-right: 5px;
      }

      .status {
        margin-top: 10px;
        font-size: 0.9em;
      }

      .open {
        color: #4caf50;
        font-weight: bold;
      }

      .closed {
        color: #f44336;
        font-weight: bold;
      }

      .distance {
        color: #666;
        font-size: 0.9em;
        margin-top: 5px;
      }

      .no-results {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #667eea;
      }

      .spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #map {
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        border-radius: 15px;
      }

      .map-info-window {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        padding: 15px;
        max-width: 300px;
      }

      .map-info-title {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 8px;
        color: #333;
      }

      .map-info-genre {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 3px 10px;
        border-radius: 15px;
        font-size: 0.85em;
        margin-bottom: 8px;
      }

      .map-info-rating {
        color: #ff9800;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .map-info-status {
        font-size: 0.9em;
        margin-bottom: 5px;
      }

      .map-info-open {
        color: #4caf50;
        font-weight: bold;
      }

      .map-info-closed {
        color: #f44336;
        font-weight: bold;
      }

      .map-legend {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }

      .map-legend h4 {
        margin-bottom: 10px;
        color: #333;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
        font-size: 0.9em;
        color: #666;
      }

      .legend-marker {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üçΩÔ∏è „Ç™„Éï„Ç£„ÇπÈ£≤È£üÂ∫ó„É¨„Ç≥„É°„É≥„ÉÄ„Éº</h1>
        <p class="subtitle">ÁèæÂú®Âñ∂Ê•≠‰∏≠„ÅÆ„Åä„Åô„Åô„ÇÅÂ∫óËàó„ÇíË©ï‰æ°È†Ü„Åß„ÅîÁ¥π‰ªã</p>
      </div>

      <div class="login-section" id="loginSection">
        <button class="google-login-btn" onclick="handleGoogleLogin()">
          Ê§úÁ¥¢„Åô„Çã
        </button>
      </div>

      <div id="mainContent" style="display: none">
        <div class="filters">
          <div class="filter-group">
            <label for="genreFilter">„Ç∏„É£„É≥„É´„ÅßÁµû„ÇäËæº„Åø</label>
            <select id="genreFilter" onchange="filterRestaurants()">
              <option value="">„Åô„Åπ„Å¶„ÅÆ„Ç∏„É£„É≥„É´</option>
              <option value="ÂíåÈ£ü">ÂíåÈ£ü</option>
              <option value="Ê¥ãÈ£ü">Ê¥ãÈ£ü</option>
              <option value="‰∏≠ËèØ">‰∏≠ËèØ</option>
              <option value="„Ç§„Çø„É™„Ç¢„É≥">„Ç§„Çø„É™„Ç¢„É≥</option>
              <option value="„Éï„É¨„É≥„ÉÅ">„Éï„É¨„É≥„ÉÅ</option>
              <option value="ÁÑºËÇâ">ÁÑºËÇâ</option>
              <option value="ÂØøÂè∏">ÂØøÂè∏</option>
              <option value="„É©„Éº„É°„É≥">„É©„Éº„É°„É≥</option>
              <option value="„Ç´„Éï„Çß">„Ç´„Éï„Çß</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="sortOrder">‰∏¶„Å≥È†Ü</label>
            <select id="sortOrder" onchange="filterRestaurants()">
              <option value="rating">Ë©ï‰æ°È†Ü</option>
              <option value="distance">Ë∑ùÈõ¢È†Ü</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="viewMode">Ë°®Á§∫„É¢„Éº„Éâ</label>
            <select id="viewMode" onchange="toggleView()">
              <option value="grid">„Ç∞„É™„ÉÉ„ÉâË°®Á§∫</option>
              <option value="map">Âú∞Âõ≥Ë°®Á§∫</option>
            </select>
          </div>
        </div>

        <div id="loadingSection" class="loading" style="display: none">
          <div class="spinner"></div>
          <p>„É¨„Çπ„Éà„É©„É≥ÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...</p>
        </div>

        <div id="restaurantGrid" class="restaurant-grid"></div>

        <div id="mapContainer" style="display: none; position: relative">
          <div id="map" style="width: 100%; height: 600px"></div>
          <div class="map-legend">
            <h4>Âá°‰æã</h4>
            <div class="legend-item">
              <div class="legend-marker" style="background: #667eea"></div>
              <span id="legendOfficeLabel">„Ç™„Éï„Ç£„Çπ</span>
            </div>
            <div class="legend-item">
              <div class="legend-marker" style="background: #4caf50"></div>
              <span>Âñ∂Ê•≠‰∏≠</span>
            </div>
            <div class="legend-item">
              <div class="legend-marker" style="background: #f44336"></div>
              <span>Âñ∂Ê•≠ÊôÇÈñìÂ§ñ</span>
            </div>
          </div>
        </div>

        <div id="noResults" class="no-results" style="display: none">
          <h3>Ë©≤ÂΩì„Åô„ÇãÂ∫óËàó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</h3>
          <p>„Éï„Ç£„É´„Çø„ÉºÊù°‰ª∂„ÇíÂ§âÊõ¥„Åó„Å¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ</p>
        </div>
      </div>
    </div>

    <script>
      // „Çµ„É≥„Éó„É´„Éá„Éº„ÇøÔºàÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØ API „Åã„ÇâÂèñÂæóÔºâ
      const sampleRestaurants = [
        {
          id: 1,
          name: "È≠öÊ≤≥Â≤∏ ÂØøÂè∏Â§ß",
          genre: "ÂØøÂè∏",
          rating: 4.8,
          distance: 150,
          isOpen: true,
          hours: "11:30-14:00, 17:00-22:00",
          image: "sushi.jpg",
          lat: 35.682, // Êù±‰∫¨ÈßÖÂë®Ëæ∫„ÅÆÂ∫ßÊ®ô‰æã
          lng: 139.768,
        },
        {
          id: 2,
          name: "„Éà„É©„ÉÉ„Éà„É™„Ç¢„Éª„ÉÄ„Éª„Ç∏„Éß„Éê„É≥„Éã",
          genre: "„Ç§„Çø„É™„Ç¢„É≥",
          rating: 4.6,
          distance: 200,
          isOpen: true,
          hours: "11:00-15:00, 17:30-23:00",
          image: "italian.jpg",
          lat: 35.6835,
          lng: 139.769,
        },
        {
          id: 3,
          name: "‰∫¨ÊáêÁü≥ Ëä±„Åã„Åå„Çä",
          genre: "ÂíåÈ£ü",
          rating: 4.7,
          distance: 300,
          isOpen: false,
          hours: "11:30-14:30, 17:30-22:00",
          image: "japanese.jpg",
          lat: 35.681,
          lng: 139.77,
        },
        {
          id: 4,
          name: "„Éì„Çπ„Éà„É≠„Éª„É´„Éº„Ç∏„É•",
          genre: "„Éï„É¨„É≥„ÉÅ",
          rating: 4.5,
          distance: 250,
          isOpen: true,
          hours: "12:00-14:30, 18:00-22:30",
          image: "french.jpg",
          lat: 35.6825,
          lng: 139.766,
        },
        {
          id: 5,
          name: "È∫∫Â±ã ‰∏ÄËºù",
          genre: "„É©„Éº„É°„É≥",
          rating: 4.4,
          distance: 100,
          isOpen: true,
          hours: "11:00-15:00, 17:00-21:00",
          image: "ramen.jpg",
          lat: 35.684,
          lng: 139.767,
        },
        {
          id: 6,
          name: "ÁÑºËÇâ ÁâõËßí",
          genre: "ÁÑºËÇâ",
          rating: 4.3,
          distance: 400,
          isOpen: true,
          hours: "11:30-15:00, 17:00-23:00",
          image: "yakiniku.jpg",
          lat: 35.6815,
          lng: 139.771,
        },
      ];

      // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
      let currentRestaurants = [];
      let isLoggedIn = false;
      let map = null;
      let markers = [];
      let officeMarker = null;
      let infoWindows = [];
      let currentLocation = null;
      let placesService = null;

      // „Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç™„Éï„Ç£„Çπ‰ΩçÁΩÆÔºàÊù±‰∫¨ÈßÖ„Çí‰æã„Å®„Åó„Å¶Ôºâ
      const DEFAULT_OFFICE_LOCATION = { lat: 35.6812, lng: 139.7671 };
      let OFFICE_LOCATION = { ...DEFAULT_OFFICE_LOCATION };

      document.getElementById("loadingSection").style.display = "block";

      setTimeout(() => {
        isLoggedIn = true;
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        document.getElementById("loadingSection").style.display = "none";
        // ÁèæÂú®Âú∞„ÇíÂèñÂæó
        getCurrentLocation();
      }, 1500);

      function getCurrentLocation() {
        if ("geolocation" in navigator) {
          // ‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó‰∏≠„ÅÆË°®Á§∫
          showLocationStatus("ÁèæÂú®Âú∞„ÇíÂèñÂæó‰∏≠...");

          navigator.geolocation.getCurrentPosition(
            // ÊàêÂäüÊôÇ
            (position) => {
              currentLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              OFFICE_LOCATION = { ...currentLocation };

              showLocationStatus("ÁèæÂú®Âú∞„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü", "success");

              // „É¨„Çπ„Éà„É©„É≥„Éá„Éº„Çø„ÇíÁèæÂú®Âú∞„ÅßÊ§úÁ¥¢ÔºàÂÆüÈöõ„ÅØAPI„ÇíÂëº„Å∂Ôºâ
              searchRestaurantsNearby(currentLocation);

              // Âú∞Âõ≥„ÇíÂàùÊúüÂåñ
              if (typeof google !== "undefined" && google.maps) {
                initMap();
              }
            },
            // „Ç®„É©„ÉºÊôÇ
            (error) => {
              let errorMessage = "‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü";
              switch (error.code) {
                case error.PERMISSION_DENIED:
                  errorMessage = "‰ΩçÁΩÆÊÉÖÂ†±„ÅÆ‰ΩøÁî®„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì";
                  break;
                case error.POSITION_UNAVAILABLE:
                  errorMessage = "‰ΩçÁΩÆÊÉÖÂ†±„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì";
                  break;
                case error.TIMEOUT:
                  errorMessage = "‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÂèñÂæó„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü";
                  break;
              }

              showLocationStatus(
                errorMessage + "Ôºà„Éá„Éï„Ç©„É´„Éà‰ΩçÁΩÆ„Çí‰ΩøÁî®Ôºâ",
                "error"
              );

              // „Éá„Éï„Ç©„É´„Éà‰ΩçÁΩÆ„ÅßÊ§úÁ¥¢
              searchRestaurantsNearby(DEFAULT_OFFICE_LOCATION);

              if (typeof google !== "undefined" && google.maps) {
                initMap();
              }
            },
            // „Ç™„Éó„Ç∑„Éß„É≥
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0,
            }
          );
        } else {
          showLocationStatus(
            "„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì",
            "error"
          );
          searchRestaurantsNearby(DEFAULT_OFFICE_LOCATION);

          if (typeof google !== "undefined" && google.maps) {
            initMap();
          }
        }
      }

      function showLocationStatus(message, type = "info") {
        const mainContent = document.getElementById("mainContent");
        let statusDiv = document.getElementById("locationStatus");

        if (!statusDiv) {
          statusDiv = document.createElement("div");
          statusDiv.id = "locationStatus";
          statusDiv.style.cssText = `
                    padding: 15px;
                    margin-bottom: 20px;
                    border-radius: 10px;
                    text-align: center;
                    font-weight: 500;
                    transition: all 0.3s ease;
                `;
          mainContent.insertBefore(statusDiv, mainContent.firstChild);
        }

        // „Çπ„Çø„Ç§„É´Ë®≠ÂÆö
        switch (type) {
          case "success":
            statusDiv.style.background = "#e8f5e9";
            statusDiv.style.color = "#2e7d32";
            break;
          case "error":
            statusDiv.style.background = "#ffebee";
            statusDiv.style.color = "#c62828";
            break;
          default:
            statusDiv.style.background = "#e3f2fd";
            statusDiv.style.color = "#1565c0";
        }

        statusDiv.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    ${
                      type === "info"
                        ? '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>'
                        : ""
                    }
                    <span>${message}</span>
                    ${
                      currentLocation
                        ? `<button onclick="refreshLocation()" style="margin-left: 10px; padding: 5px 15px; background: #667eea; color: white; border: none; border-radius: 20px; cursor: pointer;">‰ΩçÁΩÆÊÉÖÂ†±„ÇíÊõ¥Êñ∞</button>`
                        : ""
                    }
                </div>
            `;

        // ÊàêÂäü„Éª„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅØ5ÁßíÂæå„Å´ËñÑ„Åè„Åô„Çã
        if (type !== "info") {
          setTimeout(() => {
            statusDiv.style.opacity = "0.7";
          }, 5000);
        }
      }

      function refreshLocation() {
        getCurrentLocation();
      }

      function searchRestaurantsNearby(location) {
        console.log("Searching restaurants near:", location);

        // Google Places API „Çí‰ΩøÁî®„Åó„ÅüÊ§úÁ¥¢
        if (!placesService && map) {
          placesService = new google.maps.places.PlacesService(map);
        }

        if (!placesService) {
          console.error("Places service not initialized");
          return;
        }

        // Ê§úÁ¥¢„Éë„É©„É°„Éº„Çø
        const request = {
          location: new google.maps.LatLng(location.lat, location.lng),
          radius: 1000, // 1kmÂúèÂÜÖ
          type: "restaurant",
          language: "ja",
        };

        // Nearby Search „ÇíÂÆüË°å
        placesService.nearbySearch(request, (results, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            console.log("Found places:", results.length);

            // Google Places „ÅÆ„Éá„Éº„Çø„ÇíÂÜÖÈÉ®„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Å´Â§âÊèõ
            const restaurants = results.map((place, index) => {
              const restaurant = {
                id: place.place_id,
                name: place.name,
                rating: place.rating || 0,
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng(),
                address: place.vicinity,
                priceLevel: place.price_level,
                types: place.types,
                photos: place.photos,
                placeId: place.place_id,
                isOpen: place.opening_hours
                  ? place.opening_hours.isOpen()
                  : null,
                genre: determineGenre(place.types, place.name),
                distance: calculateDistance(
                  location.lat,
                  location.lng,
                  place.geometry.location.lat(),
                  place.geometry.location.lng()
                ),
              };

              // Ë©≥Á¥∞ÊÉÖÂ†±„ÇíÂèñÂæóÔºàÂñ∂Ê•≠ÊôÇÈñì„Å™„Å©Ôºâ
              if (index < 10) {
                // ÊúÄÂàù„ÅÆ10‰ª∂„ÅÆ„ÅøË©≥Á¥∞ÂèñÂæóÔºàAPIÂà∂Èôê„ÅÆ„Åü„ÇÅÔºâ
                getPlaceDetails(place.place_id, restaurant);
              }

              return restaurant;
            });

            // „É¨„Çπ„Éà„É©„É≥„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
            currentRestaurants = restaurants
              .filter((r) => r.distance <= 1000) // 1km‰ª•ÂÜÖ
              .sort((a, b) => b.rating - a.rating); // Ë©ï‰æ°È†Ü„Åß„ÇΩ„Éº„Éà

            displayRestaurants();

            // Âú∞Âõ≥„ÅÆ„Éû„Éº„Ç´„Éº„ÇÇÊõ¥Êñ∞
            if (map) {
              updateMapMarkers();
            }
          } else {
            console.error("Places search failed:", status);
            showLocationStatus("Âë®Ëæ∫„ÅÆÈ£≤È£üÂ∫ó„ÅÆÊ§úÁ¥¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü", "error");
          }
        });
      }

      function getPlaceDetails(placeId, restaurant) {
        const request = {
          placeId: placeId,
          fields: [
            "opening_hours",
            "formatted_phone_number",
            "website",
            "utc_offset_minutes",
          ],
          language: "ja",
        };

        placesService.getDetails(request, (place, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            if (place.opening_hours) {
              restaurant.hours = place.opening_hours.weekday_text
                ? place.opening_hours.weekday_text[new Date().getDay()]
                : "Âñ∂Ê•≠ÊôÇÈñì‰∏çÊòé";
              restaurant.isOpen = place.opening_hours.isOpen();
            }
            restaurant.phone = place.formatted_phone_number;
            restaurant.website = place.website;

            // Ë°®Á§∫„ÇíÊõ¥Êñ∞
            displayRestaurants();
          }
        });
      }

      function determineGenre(types, name) {
        // Google Places API „ÅÆ„Çø„Ç§„Éó„Åã„ÇâÊó•Êú¨„ÅÆ„Ç∏„É£„É≥„É´„Å´„Éû„ÉÉ„Éî„É≥„Ç∞
        const genreMap = {
          japanese_restaurant: "ÂíåÈ£ü",
          sushi_restaurant: "ÂØøÂè∏",
          ramen_restaurant: "„É©„Éº„É°„É≥",
          italian_restaurant: "„Ç§„Çø„É™„Ç¢„É≥",
          french_restaurant: "„Éï„É¨„É≥„ÉÅ",
          chinese_restaurant: "‰∏≠ËèØ",
          korean_restaurant: "ÈüìÂõΩÊñôÁêÜ",
          thai_restaurant: "„Çø„Ç§ÊñôÁêÜ",
          indian_restaurant: "„Ç§„É≥„ÉâÊñôÁêÜ",
          cafe: "„Ç´„Éï„Çß",
          bar: "„Éê„Éº",
          bakery: "„Éô„Éº„Ç´„É™„Éº",
        };

        // ÂêçÂâç„Éô„Éº„Çπ„ÅÆÂà§ÂÆö
        const namePatterns = {
          ÂØøÂè∏: "ÂØøÂè∏",
          „Åô„Åó: "ÂØøÂè∏",
          sushi: "ÂØøÂè∏",
          „É©„Éº„É°„É≥: "„É©„Éº„É°„É≥",
          „Çâ„Éº„ÇÅ„Çì: "„É©„Éº„É°„É≥",
          ÁÑºËÇâ: "ÁÑºËÇâ",
          „Åù„Å∞: "ÂíåÈ£ü",
          „ÅÜ„Å©„Çì: "ÂíåÈ£ü",
          ËïéÈ∫¶: "ÂíåÈ£ü",
          Â§©„Å∑„Çâ: "ÂíåÈ£ü",
          „Ç§„Çø„É™„Ç¢„É≥: "„Ç§„Çø„É™„Ç¢„É≥",
          „Éë„Çπ„Çø: "„Ç§„Çø„É™„Ç¢„É≥",
          „Éî„Ç∂: "„Ç§„Çø„É™„Ç¢„É≥",
          „Éï„É¨„É≥„ÉÅ: "„Éï„É¨„É≥„ÉÅ",
          „Éì„Çπ„Éà„É≠: "„Éï„É¨„É≥„ÉÅ",
          ‰∏≠ËèØ: "‰∏≠ËèØ",
          È§ÉÂ≠ê: "‰∏≠ËèØ",
          „Ç´„Éï„Çß: "„Ç´„Éï„Çß",
          „Ç≥„Éº„Éí„Éº: "„Ç´„Éï„Çß",
          coffee: "„Ç´„Éï„Çß",
        };

        // „Çø„Ç§„Éó„Åã„ÇâÂà§ÂÆö
        for (const type of types) {
          if (genreMap[type]) {
            return genreMap[type];
          }
        }

        // ÂêçÂâç„Åã„ÇâÂà§ÂÆö
        const lowerName = name.toLowerCase();
        for (const [pattern, genre] of Object.entries(namePatterns)) {
          if (lowerName.includes(pattern.toLowerCase())) {
            return genre;
          }
        }

        // „Éá„Éï„Ç©„É´„Éà
        return types.includes("cafe") ? "„Ç´„Éï„Çß" : "„É¨„Çπ„Éà„É©„É≥";
      }

      function updateRestaurantDistances(userLocation) {
        // ÂÆüÈöõ„ÅÆË∑ùÈõ¢„ÇíË®àÁÆóÔºàÁ∞°ÊòìÁâàÔºâ
        sampleRestaurants.forEach((restaurant) => {
          const distance = calculateDistance(
            userLocation.lat,
            userLocation.lng,
            restaurant.lat,
            restaurant.lng
          );
          restaurant.distance = Math.round(distance);
        });
      }

      function calculateDistance(lat1, lon1, lat2, lon2) {
        // Haversine formula „Çí‰ΩøÁî®„Åó„ÅüË∑ùÈõ¢Ë®àÁÆó
        const R = 6371e3; // Âú∞ÁêÉ„ÅÆÂçäÂæÑÔºà„É°„Éº„Éà„É´Ôºâ
        const œÜ1 = (lat1 * Math.PI) / 180;
        const œÜ2 = (lat2 * Math.PI) / 180;
        const ŒîœÜ = ((lat2 - lat1) * Math.PI) / 180;
        const ŒîŒª = ((lon2 - lon1) * Math.PI) / 180;

        const a =
          Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
          Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c; // „É°„Éº„Éà„É´Âçò‰Ωç
      }

      function initMap() {
        // Âá°‰æã„ÅÆ„É©„Éô„É´„ÇíÊõ¥Êñ∞
        const legendLabel = document.getElementById("legendOfficeLabel");
        if (legendLabel) {
          legendLabel.textContent = currentLocation ? "ÁèæÂú®Âú∞" : "„Ç™„Éï„Ç£„Çπ";
        }

        // Âú∞Âõ≥„ÅÆ„Çπ„Çø„Ç§„É´Ë®≠ÂÆö
        const mapStyles = [
          {
            featureType: "poi.business",
            elementType: "labels",
            stylers: [{ visibility: "off" }],
          },
          {
            featureType: "transit",
            elementType: "labels.icon",
            stylers: [{ visibility: "off" }],
          },
        ];

        // Âú∞Âõ≥„ÅÆÂàùÊúüÂåñ
        map = new google.maps.Map(document.getElementById("map"), {
          center: OFFICE_LOCATION,
          zoom: 16,
          styles: mapStyles,
          mapTypeControl: false,
          fullscreenControl: false,
          streetViewControl: true,
        });

        // Places Service „ÇíÂàùÊúüÂåñ
        placesService = new google.maps.places.PlacesService(map);

        // „Ç´„Çπ„Çø„É†„Éû„Éº„Ç´„Éº„Ç¢„Ç§„Ç≥„É≥
        const officeIcon = {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 12,
          fillColor: "#667eea",
          fillOpacity: 0.9,
          strokeColor: "#ffffff",
          strokeWeight: 3,
        };

        // „Ç™„Éï„Ç£„Çπ„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†
        officeMarker = new google.maps.Marker({
          position: OFFICE_LOCATION,
          map: map,
          title: currentLocation ? "ÁèæÂú®Âú∞" : "„Ç™„Éï„Ç£„Çπ",
          icon: officeIcon,
          zIndex: 1000,
        });

        // „Ç™„Éï„Ç£„Çπ„ÅÆÊÉÖÂ†±„Ç¶„Ç£„É≥„Éâ„Ç¶
        const officeInfoWindow = new google.maps.InfoWindow({
          content: `<div style="padding: 10px;"><strong>${
            currentLocation ? "ÁèæÂú®Âú∞" : "„Ç™„Éï„Ç£„Çπ"
          }</strong></div>`,
        });

        officeMarker.addListener("click", () => {
          closeAllInfoWindows();
          officeInfoWindow.open(map, officeMarker);
        });

        // „É¨„Çπ„Éà„É©„É≥„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†
        updateMapMarkers();
      }

      function updateMapMarkers() {
        if (!map) return;

        // Êó¢Â≠ò„ÅÆ„Éû„Éº„Ç´„Éº„Çí„ÇØ„É™„Ç¢
        markers.forEach((marker) => marker.setMap(null));
        markers = [];
        infoWindows = [];

        // Êñ∞„Åó„ÅÑ„Éû„Éº„Ç´„Éº„ÇíËøΩÂä†
        currentRestaurants.forEach((restaurant, index) => {
          // „Ç´„Çπ„Çø„É†„Éû„Éº„Ç´„Éº„Ç¢„Ç§„Ç≥„É≥
          const icon = {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: restaurant.isOpen ? "#4caf50" : "#f44336",
            fillOpacity: 0.9,
            strokeColor: "#ffffff",
            strokeWeight: 2,
            labelOrigin: new google.maps.Point(0, 0),
          };

          const marker = new google.maps.Marker({
            position: { lat: restaurant.lat, lng: restaurant.lng },
            map: map,
            title: restaurant.name,
            icon: icon,
            label: {
              text: String(index + 1),
              color: "#ffffff",
              fontSize: "12px",
              fontWeight: "bold",
            },
            animation: google.maps.Animation.DROP,
          });

          // ÊÉÖÂ†±„Ç¶„Ç£„É≥„Éâ„Ç¶„Çí‰ΩúÊàê
          const infoWindow = new google.maps.InfoWindow({
            content: `
                        <div class="map-info-window">
                            <div class="map-info-title">${restaurant.name}</div>
                            <span class="map-info-genre">${
                              restaurant.genre
                            }</span>
                            <div class="map-info-rating">‚≠ê ${
                              restaurant.rating
                            }</div>
                            <div class="map-info-status ${
                              restaurant.isOpen
                                ? "map-info-open"
                                : "map-info-closed"
                            }">
                                ${
                                  restaurant.isOpen
                                    ? "‚óè Âñ∂Ê•≠‰∏≠"
                                    : "‚óè Âñ∂Ê•≠ÊôÇÈñìÂ§ñ"
                                }
                            </div>
                            <div style="color: #666; font-size: 0.85em;">
                                Âñ∂Ê•≠ÊôÇÈñì: ${restaurant.hours}<br>
                                „Ç™„Éï„Ç£„Çπ„Åã„Çâ: ${restaurant.distance}m
                            </div>
                            <div style="margin-top: 10px;">
                                ${
                                  restaurant.website
                                    ? `<a href="${restaurant.website}" target="_blank" style="color: #667eea; text-decoration: none; font-weight: bold;">
                                        „Ç¶„Çß„Éñ„Çµ„Ç§„Éà ‚Üí
                                    </a>`
                                    : `<a href="#" onclick="showRestaurantDetail('${restaurant.id}'); return false;" 
                                       style="color: #667eea; text-decoration: none; font-weight: bold;">
                                       Ë©≥Á¥∞„ÇíË¶ã„Çã ‚Üí
                                    </a>`
                                }
                            </div>
                        </div>
                    `,
          });

          marker.addListener("click", () => {
            closeAllInfoWindows();
            infoWindow.open(map, marker);
          });

          markers.push(marker);
          infoWindows.push(infoWindow);
        });

        // „Åô„Åπ„Å¶„ÅÆ„Éû„Éº„Ç´„Éº„ÅåË¶ã„Åà„Çã„Çà„ÅÜ„Å´Âú∞Âõ≥„ÇíË™øÊï¥
        fitMapToMarkers();
      }

      function closeAllInfoWindows() {
        infoWindows.forEach((infoWindow) => infoWindow.close());
      }

      function fitMapToMarkers() {
        if (!map || markers.length === 0) return;

        const bounds = new google.maps.LatLngBounds();
        bounds.extend(OFFICE_LOCATION);

        markers.forEach((marker) => {
          bounds.extend(marker.getPosition());
        });

        map.fitBounds(bounds);

        // „Ç∫„Éº„É†„É¨„Éô„É´„ÅåÂ§ß„Åç„Åô„Åé„ÇãÂ†¥Âêà„ÅØË™øÊï¥
        const listener = google.maps.event.addListener(map, "idle", () => {
          if (map.getZoom() > 18) {
            map.setZoom(18);
          }
          google.maps.event.removeListener(listener);
        });
      }

      function toggleView() {
        const viewMode = document.getElementById("viewMode").value;
        const grid = document.getElementById("restaurantGrid");
        const mapContainer = document.getElementById("mapContainer");

        if (viewMode === "map") {
          grid.style.display = "none";
          mapContainer.style.display = "block";

          // Âú∞Âõ≥„ÇíÂÜçÊèèÁîª
          if (map) {
            google.maps.event.trigger(map, "resize");
            fitMapToMarkers();
          }
        } else {
          grid.style.display = "grid";
          mapContainer.style.display = "none";
        }
      }

      function updateOpenStatus() {
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const currentTime = currentHour * 60 + currentMinute;

        sampleRestaurants.forEach((restaurant) => {
          // Á∞°ÊòìÁöÑ„Å™Âñ∂Ê•≠ÊôÇÈñì„ÉÅ„Çß„ÉÉ„ÇØÔºàÂÆüÈöõ„ÅØ„ÇÇ„Å£„Å®Ë§áÈõë„Å™Âá¶ÁêÜ„ÅåÂøÖË¶ÅÔºâ
          if (currentHour >= 11 && currentHour < 22) {
            restaurant.isOpen = Math.random() > 0.3; // 70%„ÅÆÁ¢∫Áéá„ÅßÂñ∂Ê•≠‰∏≠
          } else {
            restaurant.isOpen = false;
          }
        });
      }

      function filterRestaurants() {
        const genreFilter = document.getElementById("genreFilter").value;
        const sortOrder = document.getElementById("sortOrder").value;

        // Google Places API „Åã„ÇâÂèñÂæó„Åó„Åü„É¨„Çπ„Éà„É©„É≥„Éá„Éº„Çø„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        let filtered = currentRestaurants.filter((restaurant) => {
          if (genreFilter && restaurant.genre !== genreFilter) {
            return false;
          }
          // Âñ∂Ê•≠‰∏≠„Éï„Ç£„É´„ÇøÔºàÂñ∂Ê•≠ÊôÇÈñì‰∏çÊòé„ÅÆÂ†¥Âêà„ÅØË°®Á§∫Ôºâ
          if (restaurant.isOpen === false) {
            return false;
          }
          return true;
        });

        // „ÇΩ„Éº„Éà
        if (sortOrder === "rating") {
          filtered.sort((a, b) => (b.rating || 0) - (a.rating || 0));
        } else if (sortOrder === "distance") {
          filtered.sort((a, b) => a.distance - b.distance);
        }

        // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞Âæå„ÅÆ„Éá„Éº„Çø„ÅßË°®Á§∫„ÇíÊõ¥Êñ∞
        const tempRestaurants = currentRestaurants;
        currentRestaurants = filtered;
        displayRestaurants();

        // Âú∞Âõ≥„ÅÆ„Éû„Éº„Ç´„Éº„ÇÇÊõ¥Êñ∞
        if (map) {
          updateMapMarkers();
        }

        // ÂÖÉ„ÅÆ„Éá„Éº„Çø„ÇíÂæ©ÂÖÉÔºàÊ¨°Âõû„ÅÆ„Éï„Ç£„É´„Çø„É™„É≥„Ç∞Áî®Ôºâ
        currentRestaurants = tempRestaurants;
      }

      function displayRestaurants() {
        const grid = document.getElementById("restaurantGrid");
        const noResults = document.getElementById("noResults");

        if (currentRestaurants.length === 0) {
          grid.style.display = "none";
          noResults.style.display = "block";
          return;
        }

        grid.style.display = "grid";
        noResults.style.display = "none";

        grid.innerHTML = currentRestaurants
          .map((restaurant, index) => {
            // ÂÜôÁúü„ÅÆURLÔºà„ÅÇ„Çå„Å∞Ôºâ
            const photoUrl =
              restaurant.photos && restaurant.photos.length > 0
                ? restaurant.photos[0].getUrl({ maxWidth: 400, maxHeight: 300 })
                : "";

            // ‰æ°Ê†º„É¨„Éô„É´„ÅÆË°®Á§∫
            const priceLevel = restaurant.priceLevel
              ? "¬•".repeat(restaurant.priceLevel)
              : "‰æ°Ê†ºÊÉÖÂ†±„Å™„Åó";

            return `
                    <div class="restaurant-card" onclick="showRestaurantDetail('${
                      restaurant.id
                    }')">
                        ${
                          photoUrl
                            ? `<img src="${photoUrl}" alt="${restaurant.name}" class="restaurant-image">`
                            : '<div class="restaurant-image"></div>'
                        }
                        <div class="restaurant-info">
                            <div class="restaurant-header">
                                <div>
                                    <div class="restaurant-name">${
                                      restaurant.name
                                    }</div>
                                    <span class="genre-tag">${
                                      restaurant.genre
                                    }</span>
                                </div>
                                <div class="rating">
                                    ${
                                      restaurant.rating > 0
                                        ? `‚≠ê ${restaurant.rating.toFixed(1)}`
                                        : "Ë©ï‰æ°„Å™„Åó"
                                    }
                                </div>
                            </div>
                            <div class="distance">ÁèæÂú®Âú∞„Åã„Çâ ${Math.round(
                              restaurant.distance
                            )}m</div>
                            <div class="status ${
                              restaurant.isOpen === true
                                ? "open"
                                : restaurant.isOpen === false
                                ? "closed"
                                : ""
                            }">
                                ${
                                  restaurant.isOpen === true
                                    ? "‚óè Âñ∂Ê•≠‰∏≠"
                                    : restaurant.isOpen === false
                                    ? "‚óè Âñ∂Ê•≠ÊôÇÈñìÂ§ñ"
                                    : "‚óè Âñ∂Ê•≠ÊôÇÈñì‰∏çÊòé"
                                }
                            </div>
                            ${
                              restaurant.hours
                                ? `<div style="color: #666; font-size: 0.85em; margin-top: 5px;">
                                    ${restaurant.hours}
                                </div>`
                                : ""
                            }
                            <div style="color: #666; font-size: 0.85em; margin-top: 5px;">
                                ${priceLevel} ${
              restaurant.address ? `„Éª ${restaurant.address}` : ""
            }
                            </div>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function showRestaurantDetail(id) {
        const restaurant = currentRestaurants.find((r) => r.id === id);
        if (!restaurant) return;

        // Âú∞Âõ≥Ë°®Á§∫„ÅÆÂ†¥Âêà„ÄÅË©≤ÂΩì„Éû„Éº„Ç´„Éº„Å´„Éï„Ç©„Éº„Ç´„Çπ
        if (document.getElementById("viewMode").value === "map" && map) {
          const index = currentRestaurants.findIndex((r) => r.id === id);
          if (index !== -1 && markers[index]) {
            map.setCenter(markers[index].getPosition());
            map.setZoom(18);
            google.maps.event.trigger(markers[index], "click");
          }
        } else {
          // Ë©≥Á¥∞ÊÉÖÂ†±„ÇíË°®Á§∫
          let details = `${restaurant.name}„ÅÆË©≥Á¥∞ÊÉÖÂ†±\n\n`;
          details += `„Ç∏„É£„É≥„É´: ${restaurant.genre}\n`;
          details += `Ë©ï‰æ°: ${
            restaurant.rating ? restaurant.rating.toFixed(1) : "Ë©ï‰æ°„Å™„Åó"
          }\n`;
          details += `Ë∑ùÈõ¢: ${Math.round(restaurant.distance)}m\n`;
          details += `Âñ∂Ê•≠Áä∂ÊÖã: ${
            restaurant.isOpen === true
              ? "Âñ∂Ê•≠‰∏≠"
              : restaurant.isOpen === false
              ? "Âñ∂Ê•≠ÊôÇÈñìÂ§ñ"
              : "‰∏çÊòé"
          }\n`;
          if (restaurant.hours)
            details += `Êú¨Êó•„ÅÆÂñ∂Ê•≠ÊôÇÈñì: ${restaurant.hours}\n`;
          if (restaurant.priceLevel)
            details += `‰æ°Ê†ºÂ∏Ø: ${"¬•".repeat(restaurant.priceLevel)}\n`;
          if (restaurant.address) details += `‰ΩèÊâÄ: ${restaurant.address}\n`;
          if (restaurant.phone) details += `ÈõªË©±: ${restaurant.phone}\n`;
          if (restaurant.website)
            details += `\n„Ç¶„Çß„Éñ„Çµ„Ç§„Éà: ${restaurant.website}`;

          alert(details + "\n\n‚ÄªÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØË©≥Á¥∞„Éö„Éº„Ç∏„Å´ÈÅ∑Áßª„Åó„Åæ„Åô");
        }
      }

      // ÂÆöÊúüÁöÑ„Å´Âñ∂Ê•≠Áä∂ÊÖã„ÇíÊõ¥Êñ∞Ôºà5ÂàÜ„Åî„Å®Ôºâ
      setInterval(() => {
        if (isLoggedIn) {
          updateOpenStatus();
          filterRestaurants();
        }
      }, 300000);

      // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫ÊôÇ„ÅÆÂú∞Âõ≥Ë™øÊï¥
      window.addEventListener("resize", () => {
        if (map && document.getElementById("viewMode").value === "map") {
          fitMapToMarkers();
        }
      });
    </script>

    <!-- Google Maps API -->
    <script
      async
      defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCV1uoO7_nWrFKEJKhmVuF1YwM_AzOEUxE&callback=initMap&libraries=places"
    ></script>
  </body>
</html>
