<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã‚ªãƒ•ã‚£ã‚¹é£²é£Ÿåº—ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ€ãƒ¼</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 1200px;
        width: 100%;
        padding: 40px;
        animation: slideIn 0.5s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      h1 {
        color: #333;
        font-size: 2.5em;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .subtitle {
        color: #666;
        font-size: 1.1em;
      }

      .login-section {
        text-align: center;
        margin: 40px 0;
      }

      .google-login-btn {
        background: #4285f4;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 30px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
      }

      .google-login-btn:hover {
        background: #357ae8;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
      }

      .filters {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .filter-group {
        flex: 1;
        min-width: 200px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 500;
      }

      select {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: white;
      }

      select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .restaurant-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 25px;
        margin-top: 30px;
      }

      .restaurant-card {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .restaurant-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      }

      .restaurant-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
      }

      .restaurant-info {
        padding: 20px;
      }

      .restaurant-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 10px;
      }

      .restaurant-name {
        font-size: 1.3em;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
      }

      .rating {
        display: flex;
        align-items: center;
        gap: 5px;
        color: #ff9800;
        font-weight: bold;
      }

      .genre-tag {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        margin-right: 5px;
      }

      .status {
        margin-top: 10px;
        font-size: 0.9em;
      }

      .open {
        color: #4caf50;
        font-weight: bold;
      }

      .closed {
        color: #f44336;
        font-weight: bold;
      }

      .distance {
        color: #666;
        font-size: 0.9em;
        margin-top: 5px;
      }

      .no-results {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #667eea;
      }

      .spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #map {
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        border-radius: 15px;
      }

      .map-info-window {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        padding: 15px;
        max-width: 300px;
      }

      .map-info-title {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 8px;
        color: #333;
      }

      .map-info-genre {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 3px 10px;
        border-radius: 15px;
        font-size: 0.85em;
        margin-bottom: 8px;
      }

      .map-info-rating {
        color: #ff9800;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .map-info-status {
        font-size: 0.9em;
        margin-bottom: 5px;
      }

      .map-info-open {
        color: #4caf50;
        font-weight: bold;
      }

      .map-info-closed {
        color: #f44336;
        font-weight: bold;
      }

      .map-legend {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }

      .map-legend h4 {
        margin-bottom: 10px;
        color: #333;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
        font-size: 0.9em;
        color: #666;
      }

      .legend-marker {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ½ï¸ ã‚ªãƒ•ã‚£ã‚¹é£²é£Ÿåº—ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ€ãƒ¼</h1>
        <p class="subtitle">ç¾åœ¨å–¶æ¥­ä¸­ã®ãŠã™ã™ã‚åº—èˆ—ã‚’è©•ä¾¡é †ã§ã”ç´¹ä»‹</p>
      </div>

      <div class="login-section" id="loginSection">
        <button class="google-login-btn" onclick="handleGoogleLogin()">
          æ¤œç´¢ã™ã‚‹
        </button>
      </div>

      <div id="mainContent" style="display: none">
        <div class="filters">
          <div class="filter-group">
            <label for="genreFilter">ã‚¸ãƒ£ãƒ³ãƒ«ã§çµã‚Šè¾¼ã¿</label>
            <select id="genreFilter" onchange="filterRestaurants()">
              <option value="">ã™ã¹ã¦ã®ã‚¸ãƒ£ãƒ³ãƒ«</option>
              <option value="å’Œé£Ÿ">å’Œé£Ÿ</option>
              <option value="æ´‹é£Ÿ">æ´‹é£Ÿ</option>
              <option value="ä¸­è¯">ä¸­è¯</option>
              <option value="ã‚¤ã‚¿ãƒªã‚¢ãƒ³">ã‚¤ã‚¿ãƒªã‚¢ãƒ³</option>
              <option value="ãƒ•ãƒ¬ãƒ³ãƒ">ãƒ•ãƒ¬ãƒ³ãƒ</option>
              <option value="ç„¼è‚‰">ç„¼è‚‰</option>
              <option value="å¯¿å¸">å¯¿å¸</option>
              <option value="ãƒ©ãƒ¼ãƒ¡ãƒ³">ãƒ©ãƒ¼ãƒ¡ãƒ³</option>
              <option value="ã‚«ãƒ•ã‚§">ã‚«ãƒ•ã‚§</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="sortOrder">ä¸¦ã³é †</label>
            <select id="sortOrder" onchange="filterRestaurants()">
              <option value="rating">è©•ä¾¡é †</option>
              <option value="distance">è·é›¢é †</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="viewMode">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</label>
            <select id="viewMode" onchange="toggleView()">
              <option value="grid">ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º</option>
              <option value="map">åœ°å›³è¡¨ç¤º</option>
            </select>
          </div>
        </div>

        <div id="loadingSection" class="loading" style="display: none">
          <div class="spinner"></div>
          <p>ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æƒ…å ±ã‚’å–å¾—ä¸­...</p>
        </div>

        <div id="restaurantGrid" class="restaurant-grid"></div>

        <div id="mapContainer" style="display: none; position: relative">
          <div id="map" style="width: 100%; height: 600px"></div>
          <div class="map-legend">
            <h4>å‡¡ä¾‹</h4>
            <div class="legend-item">
              <div class="legend-marker" style="background: #667eea"></div>
              <span id="legendOfficeLabel">ã‚ªãƒ•ã‚£ã‚¹</span>
            </div>
            <div class="legend-item">
              <div class="legend-marker" style="background: #4caf50"></div>
              <span>å–¶æ¥­ä¸­</span>
            </div>
            <div class="legend-item">
              <div class="legend-marker" style="background: #f44336"></div>
              <span>å–¶æ¥­æ™‚é–“å¤–</span>
            </div>
          </div>
        </div>

        <div id="noResults" class="no-results" style="display: none">
          <h3>è©²å½“ã™ã‚‹åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</h3>
          <p>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãŠè©¦ã—ãã ã•ã„</p>
        </div>
      </div>
    </div>

    <script>
      // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ API ã‹ã‚‰å–å¾—ï¼‰
      const sampleRestaurants = [
        {
          id: 1,
          name: "é­šæ²³å²¸ å¯¿å¸å¤§",
          genre: "å¯¿å¸",
          rating: 4.8,
          distance: 150,
          isOpen: true,
          hours: "11:30-14:00, 17:00-22:00",
          image: "sushi.jpg",
          lat: 35.682, // æ±äº¬é§…å‘¨è¾ºã®åº§æ¨™ä¾‹
          lng: 139.768,
        },
        {
          id: 2,
          name: "ãƒˆãƒ©ãƒƒãƒˆãƒªã‚¢ãƒ»ãƒ€ãƒ»ã‚¸ãƒ§ãƒãƒ³ãƒ‹",
          genre: "ã‚¤ã‚¿ãƒªã‚¢ãƒ³",
          rating: 4.6,
          distance: 200,
          isOpen: true,
          hours: "11:00-15:00, 17:30-23:00",
          image: "italian.jpg",
          lat: 35.6835,
          lng: 139.769,
        },
        {
          id: 3,
          name: "äº¬æ‡çŸ³ èŠ±ã‹ãŒã‚Š",
          genre: "å’Œé£Ÿ",
          rating: 4.7,
          distance: 300,
          isOpen: false,
          hours: "11:30-14:30, 17:30-22:00",
          image: "japanese.jpg",
          lat: 35.681,
          lng: 139.77,
        },
        {
          id: 4,
          name: "ãƒ“ã‚¹ãƒˆãƒ­ãƒ»ãƒ«ãƒ¼ã‚¸ãƒ¥",
          genre: "ãƒ•ãƒ¬ãƒ³ãƒ",
          rating: 4.5,
          distance: 250,
          isOpen: true,
          hours: "12:00-14:30, 18:00-22:30",
          image: "french.jpg",
          lat: 35.6825,
          lng: 139.766,
        },
        {
          id: 5,
          name: "éººå±‹ ä¸€è¼",
          genre: "ãƒ©ãƒ¼ãƒ¡ãƒ³",
          rating: 4.4,
          distance: 100,
          isOpen: true,
          hours: "11:00-15:00, 17:00-21:00",
          image: "ramen.jpg",
          lat: 35.684,
          lng: 139.767,
        },
        {
          id: 6,
          name: "ç„¼è‚‰ ç‰›è§’",
          genre: "ç„¼è‚‰",
          rating: 4.3,
          distance: 400,
          isOpen: true,
          hours: "11:30-15:00, 17:00-23:00",
          image: "yakiniku.jpg",
          lat: 35.6815,
          lng: 139.771,
        },
      ];

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
      let currentRestaurants = [];
      let isLoggedIn = false;
      let map = null;
      let markers = [];
      let officeMarker = null;
      let infoWindows = [];
      let currentLocation = null;
      let placesService = null;

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚ªãƒ•ã‚£ã‚¹ä½ç½®ï¼ˆæ±äº¬é§…ã‚’ä¾‹ã¨ã—ã¦ï¼‰
      const DEFAULT_OFFICE_LOCATION = { lat: 35.6812, lng: 139.7671 };
      let OFFICE_LOCATION = { ...DEFAULT_OFFICE_LOCATION };

      document.getElementById("loadingSection").style.display = "block";

      setTimeout(() => {
        isLoggedIn = true;
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        document.getElementById("loadingSection").style.display = "none";
        // ç¾åœ¨åœ°ã‚’å–å¾—
        getCurrentLocation();
      }, 1500);

      function getCurrentLocation() {
        if ("geolocation" in navigator) {
          // ä½ç½®æƒ…å ±å–å¾—ä¸­ã®è¡¨ç¤º
          showLocationStatus("ç¾åœ¨åœ°ã‚’å–å¾—ä¸­...");

          navigator.geolocation.getCurrentPosition(
            // æˆåŠŸæ™‚
            (position) => {
              currentLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              OFFICE_LOCATION = { ...currentLocation };

              showLocationStatus("ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¾ã—ãŸ", "success");

              // ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ç¾åœ¨åœ°ã§æ¤œç´¢ï¼ˆå®Ÿéš›ã¯APIã‚’å‘¼ã¶ï¼‰
              searchRestaurantsNearby(currentLocation);

              // åœ°å›³ã‚’åˆæœŸåŒ–
              if (typeof google !== "undefined" && google.maps) {
                initMap();
              }
            },
            // ã‚¨ãƒ©ãƒ¼æ™‚
            (error) => {
              let errorMessage = "ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
              switch (error.code) {
                case error.PERMISSION_DENIED:
                  errorMessage = "ä½ç½®æƒ…å ±ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“";
                  break;
                case error.POSITION_UNAVAILABLE:
                  errorMessage = "ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“";
                  break;
                case error.TIMEOUT:
                  errorMessage = "ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ";
                  break;
              }

              showLocationStatus(
                errorMessage + "ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã‚’ä½¿ç”¨ï¼‰",
                "error"
              );

              // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã§æ¤œç´¢
              searchRestaurantsNearby(DEFAULT_OFFICE_LOCATION);

              if (typeof google !== "undefined" && google.maps) {
                initMap();
              }
            },
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0,
            }
          );
        } else {
          showLocationStatus(
            "ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“",
            "error"
          );
          searchRestaurantsNearby(DEFAULT_OFFICE_LOCATION);

          if (typeof google !== "undefined" && google.maps) {
            initMap();
          }
        }
      }

      function showLocationStatus(message, type = "info") {
        const mainContent = document.getElementById("mainContent");
        let statusDiv = document.getElementById("locationStatus");

        if (!statusDiv) {
          statusDiv = document.createElement("div");
          statusDiv.id = "locationStatus";
          statusDiv.style.cssText = `
                    padding: 15px;
                    margin-bottom: 20px;
                    border-radius: 10px;
                    text-align: center;
                    font-weight: 500;
                    transition: all 0.3s ease;
                `;
          mainContent.insertBefore(statusDiv, mainContent.firstChild);
        }

        // ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
        switch (type) {
          case "success":
            statusDiv.style.background = "#e8f5e9";
            statusDiv.style.color = "#2e7d32";
            break;
          case "error":
            statusDiv.style.background = "#ffebee";
            statusDiv.style.color = "#c62828";
            break;
          default:
            statusDiv.style.background = "#e3f2fd";
            statusDiv.style.color = "#1565c0";
        }

        statusDiv.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    ${
                      type === "info"
                        ? '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>'
                        : ""
                    }
                    <span>${message}</span>
                    ${
                      currentLocation
                        ? `<button onclick="refreshLocation()" style="margin-left: 10px; padding: 5px 15px; background: #667eea; color: white; border: none; border-radius: 20px; cursor: pointer;">ä½ç½®æƒ…å ±ã‚’æ›´æ–°</button>`
                        : ""
                    }
                </div>
            `;

        // æˆåŠŸãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯5ç§’å¾Œã«è–„ãã™ã‚‹
        if (type !== "info") {
          setTimeout(() => {
            statusDiv.style.opacity = "0.7";
          }, 5000);
        }
      }

      function refreshLocation() {
        getCurrentLocation();
      }

      function searchRestaurantsNearby(location) {
        console.log("Searching restaurants near:", location);

        // Google Places API ã‚’ä½¿ç”¨ã—ãŸæ¤œç´¢
        if (!placesService && map) {
          placesService = new google.maps.places.PlacesService(map);
        }

        if (!placesService) {
          console.error("Places service not initialized");
          return;
        }

        // æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        const request = {
          location: new google.maps.LatLng(location.lat, location.lng),
          radius: 1000, // 1kmåœå†…
          type: "restaurant",
          language: "ja",
        };

        // Nearby Search ã‚’å®Ÿè¡Œ
        placesService.nearbySearch(request, (results, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            console.log("Found places:", results.length);

            // Google Places ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†…éƒ¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›
            const restaurants = results.map((place, index) => {
              const restaurant = {
                id: place.place_id,
                name: place.name,
                rating: place.rating || 0,
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng(),
                address: place.vicinity,
                priceLevel: place.price_level,
                types: place.types,
                photos: place.photos,
                placeId: place.place_id,
                isOpen: place.opening_hours
                  ? place.opening_hours.isOpen()
                  : null,
                genre: determineGenre(place.types, place.name),
                distance: calculateDistance(
                  location.lat,
                  location.lng,
                  place.geometry.location.lat(),
                  place.geometry.location.lng()
                ),
              };

              // è©³ç´°æƒ…å ±ã‚’å–å¾—ï¼ˆå–¶æ¥­æ™‚é–“ãªã©ï¼‰
              if (index < 10) {
                // æœ€åˆã®10ä»¶ã®ã¿è©³ç´°å–å¾—ï¼ˆAPIåˆ¶é™ã®ãŸã‚ï¼‰
                getPlaceDetails(place.place_id, restaurant);
              }

              return restaurant;
            });

            // ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            currentRestaurants = restaurants
              .filter((r) => r.distance <= 1000) // 1kmä»¥å†…
              .sort((a, b) => b.rating - a.rating); // è©•ä¾¡é †ã§ã‚½ãƒ¼ãƒˆ

            displayRestaurants();

            // åœ°å›³ã®ãƒãƒ¼ã‚«ãƒ¼ã‚‚æ›´æ–°
            if (map) {
              updateMapMarkers();
            }
          } else {
            console.error("Places search failed:", status);
            showLocationStatus("å‘¨è¾ºã®é£²é£Ÿåº—ã®æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ", "error");
          }
        });
      }

      function getPlaceDetails(placeId, restaurant) {
        const request = {
          placeId: placeId,
          fields: [
            "opening_hours",
            "formatted_phone_number",
            "website",
            "utc_offset_minutes",
          ],
          language: "ja",
        };

        placesService.getDetails(request, (place, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            if (place.opening_hours) {
              restaurant.hours = place.opening_hours.weekday_text
                ? place.opening_hours.weekday_text[new Date().getDay()]
                : "å–¶æ¥­æ™‚é–“ä¸æ˜";
              restaurant.isOpen = place.opening_hours.isOpen();
            }
            restaurant.phone = place.formatted_phone_number;
            restaurant.website = place.website;

            // è¡¨ç¤ºã‚’æ›´æ–°
            displayRestaurants();
          }
        });
      }

      function determineGenre(types, name) {
        // Google Places API ã®ã‚¿ã‚¤ãƒ—ã‹ã‚‰æ—¥æœ¬ã®ã‚¸ãƒ£ãƒ³ãƒ«ã«ãƒãƒƒãƒ”ãƒ³ã‚°
        const genreMap = {
          japanese_restaurant: "å’Œé£Ÿ",
          sushi_restaurant: "å¯¿å¸",
          ramen_restaurant: "ãƒ©ãƒ¼ãƒ¡ãƒ³",
          italian_restaurant: "ã‚¤ã‚¿ãƒªã‚¢ãƒ³",
          french_restaurant: "ãƒ•ãƒ¬ãƒ³ãƒ",
          chinese_restaurant: "ä¸­è¯",
          korean_restaurant: "éŸ“å›½æ–™ç†",
          thai_restaurant: "ã‚¿ã‚¤æ–™ç†",
          indian_restaurant: "ã‚¤ãƒ³ãƒ‰æ–™ç†",
          cafe: "ã‚«ãƒ•ã‚§",
          bar: "ãƒãƒ¼",
          bakery: "ãƒ™ãƒ¼ã‚«ãƒªãƒ¼",
        };

        // åå‰ãƒ™ãƒ¼ã‚¹ã®åˆ¤å®š
        const namePatterns = {
          å¯¿å¸: "å¯¿å¸",
          ã™ã—: "å¯¿å¸",
          sushi: "å¯¿å¸",
          ãƒ©ãƒ¼ãƒ¡ãƒ³: "ãƒ©ãƒ¼ãƒ¡ãƒ³",
          ã‚‰ãƒ¼ã‚ã‚“: "ãƒ©ãƒ¼ãƒ¡ãƒ³",
          ç„¼è‚‰: "ç„¼è‚‰",
          ãã°: "å’Œé£Ÿ",
          ã†ã©ã‚“: "å’Œé£Ÿ",
          è•éº¦: "å’Œé£Ÿ",
          å¤©ã·ã‚‰: "å’Œé£Ÿ",
          ã‚¤ã‚¿ãƒªã‚¢ãƒ³: "ã‚¤ã‚¿ãƒªã‚¢ãƒ³",
          ãƒ‘ã‚¹ã‚¿: "ã‚¤ã‚¿ãƒªã‚¢ãƒ³",
          ãƒ”ã‚¶: "ã‚¤ã‚¿ãƒªã‚¢ãƒ³",
          ãƒ•ãƒ¬ãƒ³ãƒ: "ãƒ•ãƒ¬ãƒ³ãƒ",
          ãƒ“ã‚¹ãƒˆãƒ­: "ãƒ•ãƒ¬ãƒ³ãƒ",
          ä¸­è¯: "ä¸­è¯",
          é¤ƒå­: "ä¸­è¯",
          ã‚«ãƒ•ã‚§: "ã‚«ãƒ•ã‚§",
          ã‚³ãƒ¼ãƒ’ãƒ¼: "ã‚«ãƒ•ã‚§",
          coffee: "ã‚«ãƒ•ã‚§",
        };

        // ã‚¿ã‚¤ãƒ—ã‹ã‚‰åˆ¤å®š
        for (const type of types) {
          if (genreMap[type]) {
            return genreMap[type];
          }
        }

        // åå‰ã‹ã‚‰åˆ¤å®š
        const lowerName = name.toLowerCase();
        for (const [pattern, genre] of Object.entries(namePatterns)) {
          if (lowerName.includes(pattern.toLowerCase())) {
            return genre;
          }
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        return types.includes("cafe") ? "ã‚«ãƒ•ã‚§" : "ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³";
      }

      function updateRestaurantDistances(userLocation) {
        // å®Ÿéš›ã®è·é›¢ã‚’è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        sampleRestaurants.forEach((restaurant) => {
          const distance = calculateDistance(
            userLocation.lat,
            userLocation.lng,
            restaurant.lat,
            restaurant.lng
          );
          restaurant.distance = Math.round(distance);
        });
      }

      function calculateDistance(lat1, lon1, lat2, lon2) {
        // Haversine formula ã‚’ä½¿ç”¨ã—ãŸè·é›¢è¨ˆç®—
        const R = 6371e3; // åœ°çƒã®åŠå¾„ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
        const Ï†1 = (lat1 * Math.PI) / 180;
        const Ï†2 = (lat2 * Math.PI) / 180;
        const Î”Ï† = ((lat2 - lat1) * Math.PI) / 180;
        const Î”Î» = ((lon2 - lon1) * Math.PI) / 180;

        const a =
          Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
          Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c; // ãƒ¡ãƒ¼ãƒˆãƒ«å˜ä½
      }

      function initMap() {
        // å‡¡ä¾‹ã®ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
        const legendLabel = document.getElementById("legendOfficeLabel");
        if (legendLabel) {
          legendLabel.textContent = currentLocation ? "ç¾åœ¨åœ°" : "ã‚ªãƒ•ã‚£ã‚¹";
        }

        // åœ°å›³ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
        const mapStyles = [
          {
            featureType: "poi.business",
            elementType: "labels",
            stylers: [{ visibility: "off" }],
          },
          {
            featureType: "transit",
            elementType: "labels.icon",
            stylers: [{ visibility: "off" }],
          },
        ];

        // åœ°å›³ã®åˆæœŸåŒ–
        map = new google.maps.Map(document.getElementById("map"), {
          center: OFFICE_LOCATION,
          zoom: 16,
          styles: mapStyles,
          mapTypeControl: false,
          fullscreenControl: false,
          streetViewControl: true,
        });

        // Places Service ã‚’åˆæœŸåŒ–
        placesService = new google.maps.places.PlacesService(map);

        // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³
        const officeIcon = {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 12,
          fillColor: "#667eea",
          fillOpacity: 0.9,
          strokeColor: "#ffffff",
          strokeWeight: 3,
        };

        // ã‚ªãƒ•ã‚£ã‚¹ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
        officeMarker = new google.maps.Marker({
          position: OFFICE_LOCATION,
          map: map,
          title: currentLocation ? "ç¾åœ¨åœ°" : "ã‚ªãƒ•ã‚£ã‚¹",
          icon: officeIcon,
          zIndex: 1000,
        });

        // ã‚ªãƒ•ã‚£ã‚¹ã®æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
        const officeInfoWindow = new google.maps.InfoWindow({
          content: `<div style="padding: 10px;"><strong>${
            currentLocation ? "ç¾åœ¨åœ°" : "ã‚ªãƒ•ã‚£ã‚¹"
          }</strong></div>`,
        });

        officeMarker.addListener("click", () => {
          closeAllInfoWindows();
          officeInfoWindow.open(map, officeMarker);
        });

        // ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
        updateMapMarkers();
      }

      function updateMapMarkers() {
        if (!map) return;

        // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
        markers.forEach((marker) => marker.setMap(null));
        markers = [];
        infoWindows = [];

        // æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
        currentRestaurants.forEach((restaurant, index) => {
          // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³
          const icon = {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: restaurant.isOpen ? "#4caf50" : "#f44336",
            fillOpacity: 0.9,
            strokeColor: "#ffffff",
            strokeWeight: 2,
            labelOrigin: new google.maps.Point(0, 0),
          };

          const marker = new google.maps.Marker({
            position: { lat: restaurant.lat, lng: restaurant.lng },
            map: map,
            title: restaurant.name,
            icon: icon,
            label: {
              text: String(index + 1),
              color: "#ffffff",
              fontSize: "12px",
              fontWeight: "bold",
            },
            animation: google.maps.Animation.DROP,
          });

          // æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆ
          const infoWindow = new google.maps.InfoWindow({
            content: `
                        <div class="map-info-window">
                            <div class="map-info-title">${restaurant.name}</div>
                            <span class="map-info-genre">${
                              restaurant.genre
                            }</span>
                            <div class="map-info-rating">â­ ${
                              restaurant.rating
                            }</div>
                            <div class="map-info-status ${
                              restaurant.isOpen
                                ? "map-info-open"
                                : "map-info-closed"
                            }">
                                ${
                                  restaurant.isOpen
                                    ? "â— å–¶æ¥­ä¸­"
                                    : "â— å–¶æ¥­æ™‚é–“å¤–"
                                }
                            </div>
                            <div style="color: #666; font-size: 0.85em;">
                                å–¶æ¥­æ™‚é–“: ${restaurant.hours}<br>
                                ã‚ªãƒ•ã‚£ã‚¹ã‹ã‚‰: ${restaurant.distance}m
                            </div>
                            <div style="margin-top: 10px;">
                                ${
                                  restaurant.website
                                    ? `<a href="${restaurant.website}" target="_blank" style="color: #667eea; text-decoration: none; font-weight: bold;">
                                        ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ â†’
                                    </a>`
                                    : `<a href="#" onclick="showRestaurantDetail('${restaurant.id}'); return false;" 
                                       style="color: #667eea; text-decoration: none; font-weight: bold;">
                                       è©³ç´°ã‚’è¦‹ã‚‹ â†’
                                    </a>`
                                }
                            </div>
                        </div>
                    `,
          });

          marker.addListener("click", () => {
            closeAllInfoWindows();
            infoWindow.open(map, marker);
          });

          markers.push(marker);
          infoWindows.push(infoWindow);
        });

        // ã™ã¹ã¦ã®ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«åœ°å›³ã‚’èª¿æ•´
        fitMapToMarkers();
      }

      function closeAllInfoWindows() {
        infoWindows.forEach((infoWindow) => infoWindow.close());
      }

      function fitMapToMarkers() {
        if (!map || markers.length === 0) return;

        const bounds = new google.maps.LatLngBounds();
        bounds.extend(OFFICE_LOCATION);

        markers.forEach((marker) => {
          bounds.extend(marker.getPosition());
        });

        map.fitBounds(bounds);

        // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãŒå¤§ãã™ãã‚‹å ´åˆã¯èª¿æ•´
        const listener = google.maps.event.addListener(map, "idle", () => {
          if (map.getZoom() > 18) {
            map.setZoom(18);
          }
          google.maps.event.removeListener(listener);
        });
      }

      function toggleView() {
        const viewMode = document.getElementById("viewMode").value;
        const grid = document.getElementById("restaurantGrid");
        const mapContainer = document.getElementById("mapContainer");

        if (viewMode === "map") {
          grid.style.display = "none";
          mapContainer.style.display = "block";

          // åœ°å›³ã‚’å†æç”»
          if (map) {
            google.maps.event.trigger(map, "resize");
            fitMapToMarkers();
          }
        } else {
          grid.style.display = "grid";
          mapContainer.style.display = "none";
        }
      }

      function updateOpenStatus() {
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const currentTime = currentHour * 60 + currentMinute;

        sampleRestaurants.forEach((restaurant) => {
          // ç°¡æ˜“çš„ãªå–¶æ¥­æ™‚é–“ãƒã‚§ãƒƒã‚¯ï¼ˆå®Ÿéš›ã¯ã‚‚ã£ã¨è¤‡é›‘ãªå‡¦ç†ãŒå¿…è¦ï¼‰
          if (currentHour >= 11 && currentHour < 22) {
            restaurant.isOpen = Math.random() > 0.3; // 70%ã®ç¢ºç‡ã§å–¶æ¥­ä¸­
          } else {
            restaurant.isOpen = false;
          }
        });
      }

      function filterRestaurants() {
        const genreFilter = document.getElementById("genreFilter").value;
        const sortOrder = document.getElementById("sortOrder").value;

        // Google Places API ã‹ã‚‰å–å¾—ã—ãŸãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        let filtered = currentRestaurants.filter((restaurant) => {
          if (genreFilter && restaurant.genre !== genreFilter) {
            return false;
          }
          // å–¶æ¥­ä¸­ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå–¶æ¥­æ™‚é–“ä¸æ˜ã®å ´åˆã¯è¡¨ç¤ºï¼‰
          if (restaurant.isOpen === false) {
            return false;
          }
          return true;
        });

        // ã‚½ãƒ¼ãƒˆ
        if (sortOrder === "rating") {
          filtered.sort((a, b) => (b.rating || 0) - (a.rating || 0));
        } else if (sortOrder === "distance") {
          filtered.sort((a, b) => a.distance - b.distance);
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ãƒ‡ãƒ¼ã‚¿ã§è¡¨ç¤ºã‚’æ›´æ–°
        const tempRestaurants = currentRestaurants;
        currentRestaurants = filtered;
        displayRestaurants();

        // åœ°å›³ã®ãƒãƒ¼ã‚«ãƒ¼ã‚‚æ›´æ–°
        if (map) {
          updateMapMarkers();
        }

        // å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒï¼ˆæ¬¡å›ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨ï¼‰
        currentRestaurants = tempRestaurants;
      }

      function displayRestaurants() {
        const grid = document.getElementById("restaurantGrid");
        const noResults = document.getElementById("noResults");

        if (currentRestaurants.length === 0) {
          grid.style.display = "none";
          noResults.style.display = "block";
          return;
        }

        grid.style.display = "grid";
        noResults.style.display = "none";

        grid.innerHTML = currentRestaurants
          .map((restaurant, index) => {
            // å†™çœŸã®URLï¼ˆã‚ã‚Œã°ï¼‰
            const photoUrl =
              restaurant.photos && restaurant.photos.length > 0
                ? restaurant.photos[0].getUrl({ maxWidth: 400, maxHeight: 300 })
                : "";

            // ä¾¡æ ¼ãƒ¬ãƒ™ãƒ«ã®è¡¨ç¤º
            const priceLevel = restaurant.priceLevel
              ? "Â¥".repeat(restaurant.priceLevel)
              : "ä¾¡æ ¼æƒ…å ±ãªã—";

            return `
                    <div class="restaurant-card" onclick="showRestaurantDetail('${
                      restaurant.id
                    }')">
                        ${
                          photoUrl
                            ? `<img src="${photoUrl}" alt="${restaurant.name}" class="restaurant-image">`
                            : '<div class="restaurant-image"></div>'
                        }
                        <div class="restaurant-info">
                            <div class="restaurant-header">
                                <div>
                                    <div class="restaurant-name">${
                                      restaurant.name
                                    }</div>
                                    <span class="genre-tag">${
                                      restaurant.genre
                                    }</span>
                                </div>
                                <div class="rating">
                                    ${
                                      restaurant.rating > 0
                                        ? `â­ ${restaurant.rating.toFixed(1)}`
                                        : "è©•ä¾¡ãªã—"
                                    }
                                </div>
                            </div>
                            <div class="distance">ç¾åœ¨åœ°ã‹ã‚‰ ${Math.round(
                              restaurant.distance
                            )}m</div>
                            <div class="status ${
                              restaurant.isOpen === true
                                ? "open"
                                : restaurant.isOpen === false
                                ? "closed"
                                : ""
                            }">
                                ${
                                  restaurant.isOpen === true
                                    ? "â— å–¶æ¥­ä¸­"
                                    : restaurant.isOpen === false
                                    ? "â— å–¶æ¥­æ™‚é–“å¤–"
                                    : "â— å–¶æ¥­æ™‚é–“ä¸æ˜"
                                }
                            </div>
                            ${
                              restaurant.hours
                                ? `<div style="color: #666; font-size: 0.85em; margin-top: 5px;">
                                    ${restaurant.hours}
                                </div>`
                                : ""
                            }
                            <div style="color: #666; font-size: 0.85em; margin-top: 5px;">
                                ${priceLevel} ${
              restaurant.address ? `ãƒ» ${restaurant.address}` : ""
            }
                            </div>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function showRestaurantDetail(id) {
        const restaurant = currentRestaurants.find((r) => r.id === id);
        if (!restaurant) return;

        // åœ°å›³è¡¨ç¤ºã®å ´åˆã€è©²å½“ãƒãƒ¼ã‚«ãƒ¼ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        if (document.getElementById("viewMode").value === "map" && map) {
          const index = currentRestaurants.findIndex((r) => r.id === id);
          if (index !== -1 && markers[index]) {
            map.setCenter(markers[index].getPosition());
            map.setZoom(18);
            google.maps.event.trigger(markers[index], "click");
          }
        } else {
          // è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
          let details = `${restaurant.name}ã®è©³ç´°æƒ…å ±\n\n`;
          details += `ã‚¸ãƒ£ãƒ³ãƒ«: ${restaurant.genre}\n`;
          details += `è©•ä¾¡: ${
            restaurant.rating ? restaurant.rating.toFixed(1) : "è©•ä¾¡ãªã—"
          }\n`;
          details += `è·é›¢: ${Math.round(restaurant.distance)}m\n`;
          details += `å–¶æ¥­çŠ¶æ…‹: ${
            restaurant.isOpen === true
              ? "å–¶æ¥­ä¸­"
              : restaurant.isOpen === false
              ? "å–¶æ¥­æ™‚é–“å¤–"
              : "ä¸æ˜"
          }\n`;
          if (restaurant.hours)
            details += `æœ¬æ—¥ã®å–¶æ¥­æ™‚é–“: ${restaurant.hours}\n`;
          if (restaurant.priceLevel)
            details += `ä¾¡æ ¼å¸¯: ${"Â¥".repeat(restaurant.priceLevel)}\n`;
          if (restaurant.address) details += `ä½æ‰€: ${restaurant.address}\n`;
          if (restaurant.phone) details += `é›»è©±: ${restaurant.phone}\n`;
          if (restaurant.website)
            details += `\nã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ: ${restaurant.website}`;

          alert(details + "\n\nâ€»å®Ÿéš›ã®å®Ÿè£…ã§ã¯è©³ç´°ãƒšãƒ¼ã‚¸ã«é·ç§»ã—ã¾ã™");
        }
      }

      // å®šæœŸçš„ã«å–¶æ¥­çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆ5åˆ†ã”ã¨ï¼‰
      setInterval(() => {
        if (isLoggedIn) {
          updateOpenStatus();
          filterRestaurants();
        }
      }, 300000);

      // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®åœ°å›³èª¿æ•´
      window.addEventListener("resize", () => {
        if (map && document.getElementById("viewMode").value === "map") {
          fitMapToMarkers();
        }
      });
    </script>

    <!-- Google Maps API -->
    <script
      async
      defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCV1uoO7_nWrFKEJKhmVuF1YwM_AzOEUxE&callback=initMap&libraries=places"
    ></script>
  </body>
</html>
